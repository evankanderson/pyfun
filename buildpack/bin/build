#!/usr/bin/env bash

set -euo pipefail

layers_dir="$1"
env_dir="$2/env"
plan_path="$3"

logfile="__debug_only__.txt"
ls $layers_dir >> $logfile
echo "-----" >> $logfile
ls $env_dir >> $logfile
echo "-----" >> $logfile
env >> $logfile

packages="$layers_dir/func-packages"

mkdir "$packages"
echo "launch = true" > "$packages.toml"
# export PYTHONUSERBASE="$packages"

pip install --compile --user --disable-pip-version-check "http-containerize>=0.4.0"

echo "launch = true" > "${PYTHONUSERBASE}.toml"

echo "=====" >> $logfile
ls "$packages" >> $logfile

cat > "$layers_dir/launch.toml" <<EOF
[[processes]]
type = "web"
command = "python3 -m framework"
EOF

exit 0
